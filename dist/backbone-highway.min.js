!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],t):(e.Backbone=e.Backbone||{},e.Backbone.Highway=t(e._,e.Backbone))}(this,function(e,t){"use strict";function n(t){this.definition=e.extend({},f,t),this.configure()}e="default"in e?e["default"]:e,t="default"in t?t["default"]:t;var r={headingSlash:/^(\/|#)/,trailingSlash:/\/$/,parentheses:/[\(\)]/g,optionalParams:/\((.*?)\)/g,splatParams:/\*\w+/g,namedParam:/(\(\?)?:\w+/,namedParams:/(\(\?)?:\w+/g},a={re:r,stripHeadingSlash:function(t){return e.isString(t)&&t.replace(r.headingSlash,"")},routeToRegExp:function(e){return t.Router.prototype._routeToRegExp(e)},isValidArgsArray:function(t){return!e.isEmpty(a.sanitizeArgs(t))},sanitizeArgs:function(t){return e.isObject(t)||e.isArray(t)||(t=[t]),e.without(t,null,void 0)},removeOptionalParams:function(e){return e.replace(r.optionalParams,"")},replaceArgs:function(t,n){return e.forEach(a.sanitizeArgs(n),function(e){t=a.replaceArg(t,e)}),e.forEach(t.match(r.optionalParams),function(e){a.isNamedOrSplatParam(e)&&(t=t.replace(e,""))}),t},replaceArg:function(e,t){return e.indexOf(":")!==-1?e.replace(r.namedParam,t):e.replace(r.splatParams,t)},isNamedOrSplatParam:function(e){return r.namedParam.test(e)||r.splatParams.test(e)},removeTrailingSlash:function(e){return e.replace(r.trailingSlash,"")},removeHeadingSlash:function(t){return e.isString(t)&&t.replace(r.headingSlash,"")},removeParentheses:function(e){return e.replace(r.parentheses,"")},removeRootUrl:function(t,n){return e.isString(t)&&t.replace(n,"")}},i={},o={},s={get:function(e){return o[e]},set:function(e,t){o[e]=t},save:function(t){var n=t.get("name");if(e.has(i,n))throw new Error("[ highway ] Route named "+n+" already declared");i[n]=t},find:function(e){if(e.path){var t=this.get("options");e.path=a.removeHeadingSlash(a.removeRootUrl(e.path,t.root))}return this.findByName(e.name)||this.findByPath(e.path)},findByName:function(t){return t&&e.find(i,function(e){return t===e.get("name")})},findByPath:function(t){return t&&e.find(i,function(e){return e.pathRegExp.test(t)})},getDefinitions:function(){var t={},n={};return e.forEach(i,function(e,n){t[e.get("path")]=n}),e.forEach(i,function(e,t){n[t]=e.get("action")}),e.extend({routes:t},n)}},u=["pushState","hashChange","silent","root"],c={create:function(){var e=t.Router.extend(s.getDefinitions());return new e},start:function(n){return t.History.started?null:t.history.start(e.pick(n,u))},restart:function(){t.history.stop(),t.history.start()}},h={send:function(t,n,r){if(!e.isArray(n))throw new Error("[ highway ] Route events definition for "+t+" needs to be an Array");var a=s.get("options"),i=a.dispatcher;if(!i)throw new Error("[ highway ] No dispatcher has been declared to trigger events");n.forEach(function(t){e.isString(t)&&(t={name:t}),r=t.args||t.params||r,console.log("Trigger event "+t.name+", args:",r),i.trigger.apply(i,[t.name].concat(r))})}},g=["403","404"],f={name:null,path:null,action:null},p={trigger:!0,replace:!1};n.prototype={get:function(e){return this.definition[e]},set:function(e,t){this.definition[e]=t},parse:function(e){var t=this.get("path");return a.isValidArgsArray(e)?(t=a.replaceArgs(t,e),t=a.removeTrailingSlash(a.removeParentheses(t))):a.removeOptionalParams(t)},configure:function(){var t=this.definition,n=t.name,r=t.path;r&&!e.contains(g,n)&&(this.set("path",a.stripHeadingSlash(this.get("path"))),this.pathRegExp=a.routeToRegExp(this.get("path"))),this.set("action",this.getActionWrapper())},execute:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];this.get("action").apply(void 0,e)},getActionWrapper:function(){var e=this.definition,t=e.name,n=e.action,r=e.events;return function(){for(var e=[],a=arguments.length;a--;)e[a]=arguments[a];r&&h.send(t,r,e),n.apply(void 0,e)}},getNavigateOptions:function(t){return e.extend({},p,e.pick(t,["trigger","replace"]))}};var l={pushState:!0,root:"",hashChange:!0,silent:!1,debug:!0,dispatcher:null},d=function(){var e=s.findByName("404");if(!e)throw new Error("[ highway ] 404! Landing route is not registered");e.execute()},m=null,v={start:function(t){t=e.extend({},l,t),s.set("options",t),this.router=c.create();var n=c.start(t);n||t.silent||d()},route:function y(e){var y=new n(e);s.save(y),this.router&&y.get("path")&&this.router.route(y.get("path"),y.get("name"),y.get("action"))},go:function(t){if(!e.isString(t)&&!e.isObject(t))throw new Error('[ highway.go ] Navigate option needs to be a string or an object, got "'+t+'"');if(e.isObject(t)&&!t.name&&!t.path)throw new Error('[ highway.go ] Navigate object is missing a "name" or "path" key');e.isString(t)&&(t={name:t});var n=s.find(t);return n?(t.path||(t.path=n.parse(t.args||t.params)),this.router.navigate(t.path,n.getNavigateOptions(t)),t.force&&m&&n.get("name")===m.get("name")&&this.reload(),m=n,!0):(d(),!1)},reload:c.restart,restart:c.restart};return v});