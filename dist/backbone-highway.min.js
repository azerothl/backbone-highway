!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("underscore"),require("backbone"),require("url-composer")):"function"==typeof define&&define.amd?define(["underscore","backbone","url-composer"],e):(t.Backbone=t.Backbone||{},t.Backbone.Highway=e(t._,t.Backbone,t.urlComposer))}(this,function(t,e,n){"use strict";function r(){function e(t){return s[t]}function n(t,e){s[t]=e}function r(e){var n=e.get("name");if(t.has(o,n))throw new Error("[ highway ] Route named "+n+" already declared");o[n]=e}function i(e){if(e.path){var n=this.get("options");e.path=e.path.replace(n.root,"").replace(/^(\/|#)/,"")}return t.find(o,function(t){return e.name===t.get("name")||t.pathRegExp&&t.pathRegExp.test(e.path)})}function a(){var e={},n={};return t.forEach(o,function(t,n){e[t.get("path")]=n}),t.forEach(o,function(t,e){n[e]=t.get("action")}),t.extend({routes:e},n)}var o={},s={};return{get:e,set:n,save:r,find:i,getDefinitions:a}}function i(e){this.definition=t.extend({},c,e),this.configure()}t="default"in t?t["default"]:t,e="default"in e?e["default"]:e,n="default"in n?n["default"]:n;var a=r(),o={create:function(){var t=e.Router.extend(a.getDefinitions());return new t},start:function(n){return e.History.started?null:e.history.start(t.pick(n,["pushState","hashChange","silent","root"]))},restart:function(){e.history.stop(),e.history.start()}},s={send:function(e,n,r){if(!t.isArray(n))throw new Error("[ highway ] Route events definition for "+e+" needs to be an Array");var i=a.get("options"),o=i.dispatcher;if(!o)throw new Error("[ highway ] No dispatcher has been declared to trigger events");n.forEach(function(e){t.isString(e)&&(e={name:e}),r=e.args||e.params||r,console.log("Trigger event "+e.name+", args:",r),o.trigger.apply(o,[e.name].concat(r))})}},u=["404"],c={name:null,path:null,action:null},h={trigger:!0,replace:!1};i.prototype={get:function(t){return this.definition[t]},set:function(t,e){this.definition[t]=e},parse:function(t){var e=this.get("path");return n.build({path:e,params:t})},configure:function(){var e=this.definition,r=e.name,i=e.path;i&&!t.includes(u,r)&&(t.isString(i)&&(i=i.replace(/^(\/|#)/,"")),this.pathRegExp=n.regex(i),this.set("path",i)),this.set("action",this.getActionWrapper())},execute:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];this.get("action").apply(void 0,t)},getActionWrapper:function(){var t=this.definition,e=t.name,n=t.action,r=t.events;return function(){for(var t=[],i=arguments.length;i--;)t[i]=arguments[i];r&&s.send(e,r,t),n.apply(void 0,t)}},getNavigateOptions:function(e){return t.extend({},h,t.pick(e,["trigger","replace"]))}};var f={pushState:!0,root:"",hashChange:!0,silent:!1,debug:!1,dispatcher:null},g=function(){var t=a.find({name:"404"});t&&t.execute()},p=null,d={start:function(e){e=t.extend({},f,e),a.set("options",e),this.router=o.create();var n=o.start(e);n||e.silent||g()},route:function l(t){var l=new i(t);a.save(l),this.router&&l.get("path")&&this.router.route(l.get("path"),l.get("name"),l.get("action"))},go:function(e){if(!t.isString(e)&&!t.isObject(e))throw new Error('[ highway.go ] Navigate option needs to be a string or an object, got "'+e+'"');if(t.isObject(e)&&!e.name&&!e.path)throw new Error('[ highway.go ] Navigate object is missing a "name" or "path" key');t.isString(e)&&(e={name:e});var n=a.find(e);return n?(e.path||(e.path=n.parse(e.args||e.params)),this.router.navigate(e.path,n.getNavigateOptions(e)),e.force&&p&&n.get("name")===p.get("name")&&this.reload(),p=n,!0):(g(),!1)},reload:o.restart,restart:o.restart};return d});