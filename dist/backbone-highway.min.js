!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],e):(t.Backbone=t.Backbone||{},t.Backbone.Highway=e(t._,t.Backbone))}(this,function(t,e){"use strict";function n(t){return"[object Array]"===Object.prototype.toString.call(t)}function r(t){if(null==t)return!0;if(t.length>0)return!1;if(0===t.length)return!0;if("object"!=typeof t)return!0;for(var e in t)if(hasOwnProperty.call(t,e))return!1;return!0}function i(t,e){return t=t||"",e=e||[],r(e)?c(t):(t=a(t,e),s(f(t)))}function a(t,e){if(e=e||[],!n(e)){var r=t.match(S);e=r.map(function(t){return e[t.substr(1)]})}e.forEach(function(e){t=o(t,e)});var i=t.match(B);return i&&i.forEach(function(e){u(e)&&(t=t.replace(e,""))}),t}function o(t,e){var n=t.indexOf(":")!==-1;return e=encodeURIComponent(e),n?t.replace(R,e):t.replace(N,e)}function u(t){return R.test(t)||N.test(t)}function c(t){return t.replace(B,"")}function s(t){return t.replace(j,"")}function f(t){return t.replace(k,"")}function h(t){return t=t.replace(O,"\\$&").replace(B,"(?:$1)?").replace(S,function(t,e){return e?t:"([^/?]+)"}).replace(N,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")}function p(t){return t=t||{},i(t.path,t.params)}function g(t){var e=[];t=t||{};for(var n in t.query){var r=t.query[n];e.push(n+"="+encodeURIComponent(r))}return e.length?e.join("&"):""}function d(t){t=t||{};var e=h(t.path);return e.test(t.url)}function l(t){t=t||{},t.host=t.host||"",t.hash=t.hash?"#"+t.hash:"";var e=g(t);return e=e?"?"+e:"",""+t.host+p(t)+e+t.hash}function v(e){this.definition=t.extend({},$,e),this.configure()}t="default"in t?t["default"]:t,e="default"in e?e["default"]:e;var y={},m={},w={get:function(t){return m[t]},set:function(t,e){m[t]=e},save:function(e){var n=e.get("name");if(t.has(y,n))throw new Error("[ highway ] Route named "+n+" already declared");y[n]=e},find:function(t){if(t.path){var e=this.get("options");t.path=t.path.replace(e.root,"").replace(/^(\/|#)/,"")}return this.findByName(t.name)||this.findByPath(t.path)},findByName:function(e){return e&&t.find(y,function(t){return e===t.get("name")})},findByPath:function(e){return e&&t.find(y,function(t){return t.pathRegExp.test(e)})},getDefinitions:function(){var e={},n={};return t.forEach(y,function(t,n){e[t.get("path")]=n}),t.forEach(y,function(t,e){n[e]=t.get("action")}),t.extend({routes:e},n)}},b=["pushState","hashChange","silent","root"],x={create:function(){var t=e.Router.extend(w.getDefinitions());return new t},start:function(n){return e.History.started?null:e.history.start(t.pick(n,b))},restart:function(){e.history.stop(),e.history.start()}},E={send:function(e,n,r){if(!t.isArray(n))throw new Error("[ highway ] Route events definition for "+e+" needs to be an Array");var i=w.get("options"),a=i.dispatcher;if(!a)throw new Error("[ highway ] No dispatcher has been declared to trigger events");n.forEach(function(e){t.isString(e)&&(e={name:e}),r=e.args||e.params||r,console.log("Trigger event "+e.name+", args:",r),a.trigger.apply(a,[e.name].concat(r))})}},j=/\/$/,k=/[\(\)]/g,B=/\((.*?)\)/g,N=/\*\w+/g,R=/(\(\?)?:\w+/,S=/(\(\?)?:\w+/g,O=/[\-{}\[\]+?.,\\\^$|#\s]/g,q={build:l,test:d,path:p,query:g,regex:h},A=["403","404"],$={name:null,path:null,action:null},C={trigger:!0,replace:!1};v.prototype={get:function(t){return this.definition[t]},set:function(t,e){this.definition[t]=e},parse:function(t){var e=this.get("path");return q.build({path:e,params:t})},configure:function(){var e=this.definition,n=e.name,r=e.path;r&&!t.includes(A,n)&&(t.isString(r)&&(r=r.replace(/^(\/|#)/,"")),this.pathRegExp=q.regex(r),this.set("path",r)),this.set("action",this.getActionWrapper())},execute:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];this.get("action").apply(void 0,t)},getActionWrapper:function(){var t=this.definition,e=t.name,n=t.action,r=t.events;return function(){for(var t=[],i=arguments.length;i--;)t[i]=arguments[i];r&&E.send(e,r,t),n.apply(void 0,t)}},getNavigateOptions:function(e){return t.extend({},C,t.pick(e,["trigger","replace"]))}};var P={pushState:!0,root:"",hashChange:!0,silent:!1,debug:!1,dispatcher:null},D=function(){var t=w.findByName("404");if(!t)throw new Error("[ highway ] 404! Landing route is not registered");t.execute()},H=null,I={start:function(e){e=t.extend({},P,e),w.set("options",e),this.router=x.create();var n=x.start(e);n||e.silent||D()},route:function U(t){var U=new v(t);w.save(U),this.router&&U.get("path")&&this.router.route(U.get("path"),U.get("name"),U.get("action"))},go:function(e){if(!t.isString(e)&&!t.isObject(e))throw new Error('[ highway.go ] Navigate option needs to be a string or an object, got "'+e+'"');if(t.isObject(e)&&!e.name&&!e.path)throw new Error('[ highway.go ] Navigate object is missing a "name" or "path" key');t.isString(e)&&(e={name:e});var n=w.find(e);return n?(e.path||(e.path=n.parse(e.args||e.params)),this.router.navigate(e.path,n.getNavigateOptions(e)),e.force&&H&&n.get("name")===H.get("name")&&this.reload(),H=n,!0):(D(),!1)},reload:x.restart,restart:x.restart};return I});